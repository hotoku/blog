---
layout: post
title: nim
date: 2020-10-12 00:00:41 +0900
categories: math
---

次のような2人で行うゲームをnimと言うらしい。そして、これには簡単な必勝戦略があるそうだ。

- 最初、小石が積まれた山が複数個ある
- 交互に、任意に1つの山を選び1個以上の石を取り除く
- 石がなくなるまで繰り返し、最後の石を取った方が勝ち

このゲームの状態は、山の数だけの整数で表現される。任意の状態が与えられたとき、先手必勝か後手必勝かを、以下の基準で判断できる。

```
各山の石の個数をs[1], s[2], .. , s[N]とすると、

先手必勝 ⇔ s[1] xor s[2] xor ... xor s[N] != 0
```

## 証明のポイント
1. `s[1] xor s[2] xor ... xor s[N] != 0` のとき、うまく行動を選べば`s[1] xor s[2] xor ... xor s[N] = 0`にできる
2. `s[1] xor s[2] xor ... xor s[N] = 0` のとき、どう行動しても`s[1] xor s[2] xor ... xor s[N] != 0`になってしまう

### 1の行動の選び方

1. `s[1] xor s[2] xor ... xor s[N]`を計算し、最左の1を探す。その場所を右からpビット目とする。
2. 右からpビット目が1であるような数字を`s[i]`から探す。
3. `s[i]`の右から1,2,..,pビット目を、全体のxorが0になるように選ぶ。このとき、pビット目は必ず1→0に反転する。また、それにより、得られた数字は元の`s[i]`より真に小さくなることが分かる。
   i番目の山の石の個数を、このようにして得られた値になるように石を取り出せば、条件を満たす。

### 2の行動について

どのやまから石を取り除いても、その山の数字のどこかのビットは必ず反転する。その結果、全体のxorは0ではなくなる。

### 必勝法

上記のように先手が`xor = 0`の局面を後手に渡し続ける限り、後手の行動後のxorは0にはなり得ない。最後の石を取り除いた結果のxorは0なので、後手が最後の石を取り除くことは不可能である。


## 逆のパターン

ルールを反転して、「最後の石を取ったほうが負け」とするとどうなるかを考える。以下では、最後の石を取ったほうが・・「勝ち」のルールを順ルール、「負け」のルールを逆ルールと呼ぶ。
順ルールでのゴールは、すべての山の石が0個という状態を作り出すことが目標で、逆ルールでのゴールは、ちょうど1つの山の石が1個で残りの山は0個という状態を作り出すことが目標であると考えることができる。

すぐに勝敗の判定できる状態として、すべてのiについて`s[i] <= 1`という状態を考える。この場合は1の個数が偶数なら先手必勝で奇数なら後手必勝となる。実は、それ以外の場合（つまり、少なくとも1つの山に2個以上の石がある）場合には、
順ルールと同様に`s[i]のxor != 0`なら先手必勝、それ以外では後手必勝となる。

これを示すには、次の2つを言えば良い。

1. 先手必勝状態からは、適切に行動を選べば後手必勝状態を作れる
2. 後手必勝状態からは、どうあがいても先手必勝状態しか作れない

### 1について
まず、先手必勝状態から順ルールと同様に行動することを考える。その結果、`s[i]>1`なる山ができる場合は、そのままで良い。
すべてのiについて`s[i]<=1`となる場合、xorが0という条件を満たしているはずなので`s[i]=1`となる山の個数は偶数個である。
したがって、順ルールと同じ山を選択するが1個余分に石を取ることにすれば、後手の必勝状態（`s[i]=1`となる山が奇数個）を作れる。

### 2について
1の山が奇数個という状態からは、1の山が偶数個、という状態（=先手必勝）しか作れない。

最後に、`s[i]`のxorが0で少なくとも1つのiについて`s[i] > 1`のときを考える。
後手必勝の状態を作るには、奇数個の1の山だけを残すか、`s[i]`のxorを0に保つかのどちらかしかないが、後者は不可能である。
奇数個の1の山だけを残すためには、1つの山だけが2個以上で、残りは0個か1個という状態を与えられていなければならない。
しかし、そのよう状態は`s[i]のxor != 0`であり（右から2ビット目より大きいところに1が必ず残る）後手必勝状態ではない。
したがって現在考えている条件（後手必勝状態からスタートする）に適さないため考えなくて良い。

## 参考サイト
1. [高校数学の美しい物語](https://mathtrain.jp/nim)
2. [内藤久資 1999年度名古屋大学数学高階講座](https://www.math.nagoya-u.ac.jp/~naito/lecture/high_school_1999/note.pdf)
